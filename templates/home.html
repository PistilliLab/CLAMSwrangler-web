<!DOCTYPE html>
<html lang="en">

{% extends 'base.html' %}

{% block content %}

    <div class="container-md my-2">
        <div class="row justify-content-center">
            <div class="col-md-8 text-center">
                <h3>How To Use</h3>
                <ol class="list-unstyled">
                    <li>Download the experimental configuration file template and define your subject IDs and corresponding group label. Upload the completed file.</li>
                    <li>Select all of the .csv raw CLAMS data files that you wish to process and click upload.</li>
                    <li>Enter the number of hours you wish to trim from the beginning of the data and the light cycle to start in. Somewhere between 1-6 hours for most runs, or 0 if a very short run.</li>
                    <li>Enter the number of hours you wish to retain after trimming to be used for analysis.</li>
                    <li>Enter the size of the bin in hours. Must be a factor of 12. (e.g. 1, 2, 3, 4, 6, 12)</li>
                    <li>Click “Start Processing”.</li>
                    <li>Congratulations! You saved hours of menial labor! :D</li>
                </ol>
            </div>
        </div>
    </div>
    
    <!-- Experimental Configuration File form-->
    <div class="container-md my-4">
    <h3>1.) Experimental configuration file</h3>
    <!-- button to download the experimental configuration file template -->
    <button type="button" class="btn btn-primary" onclick="window.location.href='{% url 'download_config_template' %}'">Download Config Template</button>
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div id="file-droppable1" class="drag-drop-area" onclick="document.getElementById('fileElem1').click();">
                <form class="my-form">
                    <p>Upload the filled out experimental configuration file.</p>
                    <p>Click or drag-and-drop to select file.</p>
                    <input type="file" id="fileElem1" accept=".csv" onchange="handleFiles(this.files, '1')" style="display: none;">
                    <label class="button" for="fileElem1">Select config file.</label>
                    <div id="gallery1"></div>
                </form>
                <div id="file-list1"></div>
                <button type="button" onclick="clearFiles(event, '1')">Clear Files</button>
                <button type="button" onclick="uploadFiles(event, '1')">Upload Files</button>
            </div>
        </div>
    </div>
    
    <!-- CLAMS Data File form-->
    <div class="container-md my-4">
    <h3>2.) Upload CLAMS data files.</h3>
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div id="file-droppable2" class="drag-drop-area" onclick="document.getElementById('fileElem2').click();">
                <form class="config-form">
                    <p>Upload multiple .csv files from CLAMS.</p>
                    <p>Click or drag-and-drop to select files.</p>
                    <input type="file" id="fileElem2" multiple accept=".csv" onchange="handleFiles(this.files, '2')" style="display: none;">
                    <label class="button" for="fileElem2">Select raw file(s).</label>
                    <div id="gallery2"></div>
                </form>
                <div id="file-list2"></div>
                <button type="button" onclick="clearFiles(event, '2')">Clear Files</button>
                <button type="button" onclick="uploadFiles(event, '2')">Upload Files</button>
            </div>
        </div>
    </div>

    <!-- Processing form-->
    <div class="container-md my-4">
    <h3>3.) Specify processing settings.</h3>
        <div class="row justify-content-center">
            <div class="col-md-6">
                <form id="uploadForm" method="post" enctype="multipart/form-data" class="text-center dropzone">
                    {% csrf_token %}
                    {{ form.as_p }}
                    
                    <button type="submit" class="btn btn-primary">Submit</button>
                    <a href="#" id="downloadLink" class="btn btn-secondary disabled" tabindex="-1" aria-disabled="true">Download Zip</a>
                </form>
            </div>
        </div>
    </div>

<script>
    let dropArea = document.getElementById('file-droppable')
    let fileArray = []; // Array to store files to upload

    ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false)
    })

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Identify CSRF token cookie
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function preventDefaults (e) {
        e.preventDefault()
        e.stopPropagation()
    }

    ;['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false)
    })

    ;['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false)
    })

    function highlight(e) {
        dropArea.classList.add('highlight')
    }

    function unhighlight(e) {
        dropArea.classList.remove('highlight')
    }

    dropArea.addEventListener('drop', handleDrop, false)

    function triggerFileInputClick() {
        document.getElementById('fileElem').click();
    }

    function handleDrop(e) {
        let dt = e.dataTransfer
        let files = dt.files

        handleFiles(files)
    }

    function handleFiles(files) {
        fileArray = [...files];
        displayFiles();
    }

    function clearFiles(e) {
        if (e) {
            e.stopPropagation();
        }
        fileArray = []; // Clear file array
        displayFiles(); // Update UI
        document.getElementById('fileElem').value = ""; // Reset file input
    }

    function displayFiles() {
        // Display list of files to be uploaded
        let fileNames = fileArray.map(file => file.name).join(', ');
        document.getElementById('file-list').textContent = fileNames;
    }

    function uploadFiles(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();} // Prevent the default form submission and event bubbling

        let url = '{% url "upload_csv_files" %}';
        let formData = new FormData();

        // Append all files to the same FormData object
        fileArray.forEach(file => {
            formData.append('file', file);
        });

        // Make a single fetch request to upload all files
        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken'), // Include CSRF token
            },
        })
        .then(response => response.json())
        .then(data => {
            console.log(data); // Log the response for each request
            if (data.upload_id) {
                // Update download link with the received upload_id
                let downloadLink = document.getElementById('downloadLink');
                downloadLink.href = `/download/${data.upload_id}/`; // Construct the download URL
                downloadLink.classList.remove('disabled');
                downloadLink.setAttribute('aria-disabled', 'false');
            }
            clearFiles(); // Optionally clear files after upload
            // Start checking for zip file availability, using the uploadId returned from the server
            checkZipFile(data.upload_id);
        })
        .catch(error => console.error(error));
    }

    function checkZipFile(upload_id) {
        let url = `/check-zip/${upload_id}/`; // URL to endpoint that checks for zip file existence

        fetch(url)
        .then(response => response.json())
        .then(data => {
            if(data.exists) {
                // Enable download link if zip file exists
                let downloadLink = document.getElementById('downloadLink');
                downloadLink.classList.remove('disabled');
                downloadLink.setAttribute('href', `/download/${upload_id}/`);
                downloadLink.setAttribute('aria-disabled', 'false');
                downloadLink.textContent = 'Download Zip'; // Update button text if needed
            } else {
                // Optionally, re-check after some time
                setTimeout(() => checkZipFile(upload_id), 5000); // Check every 5 seconds
            }
        })
        .catch(error => console.error('Error:', error));
    }


</script>


{% endblock content %}

</html>
